<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard IoT - DHT11</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Chart.js e MQTT -->
  <script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      color: #212529;
      transition: background-color 0.4s, color 0.4s;
    }

    h2, h4, h5, span, footer, .alert, .card, button {
      transition: all 0.3s;
    }

    /* Cards modernos */
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      padding: 1rem !important;
    }

    .dark-mode {
      background-color: #121212 !important;
      color: #f8f9fa !important;
    }

    .dark-mode .card {
      background-color: #1e1e1e !important;
      color: #f8f9fa !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .dark-mode .alert {
      background-color: #842029 !important;
      color: #fff !important;
    }

    .dark-mode button {
      background-color: #333 !important;
      color: #f8f9fa !important;
      border-color: #f8f9fa !important;
    }

    .chart-container {
      width: 100%;
      height: 300px;
    }

    /* Responsivo para celulares */
    @media (max-width: 576px) {
      .chart-container {
        height: 250px;
      }
      h4 {
        font-size: 1rem;
      }
      h5 {
        font-size: 0.95rem;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">

    <!-- Cabe√ßalho -->
    <header class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
      <div>
        <h2 class="m-0">üå°Ô∏è Dashboard IoT - DHT11</h2>
        <h5 class="m-0">T√©cnico em Desenvolvimento de Sistemas</h5>
      </div>
      <button id="toggleTema" class="btn btn-outline-secondary mt-2 mt-md-0">üåô Modo Escuro</button>
    </header>

    <!-- Indicadores -->
    <div class="row text-center mb-4">
      <div class="col-6 col-sm-6 col-md-6 mb-2 mb-md-0">
        <h4>Temperatura Atual: <span id="valorTemp" class="fw-bold">--</span> ¬∞C</h4>
      </div>
      <div class="col-6 col-sm-6 col-md-6">
        <h4>Umidade Atual: <span id="valorHum" class="fw-bold">--</span> %</h4>
      </div>
    </div>

    <!-- Alerta -->
    <div id="alertaTemperatura" class="alert alert-danger text-center fw-bold d-none" role="alert">
      ‚ö†Ô∏è Alerta: Temperatura acima do limite!
    </div>

    <!-- Gr√°ficos -->
    <div class="row g-4">
      <div class="col-12 col-md-6">
        <div class="card">
          <h5 class="card-title text-center">Temperatura (¬∞C)</h5>
          <div class="chart-container">
            <canvas id="graficoTemperatura"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="card">
          <h5 class="card-title text-center">Umidade (%)</h5>
          <div class="chart-container">
            <canvas id="graficoUmidade"></canvas>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-5 small text-muted">
      Desenvolvido por <strong>MATEUS, GABRIEL E ERICK</strong> ‚Ä¢ Projeto IoT com DHT11 e MQTT
    </footer>
  </div>

  <!-- Script principal -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

      const labels = [];
      const tempData = [];
      const humData = [];

      const ctxTemp = document.getElementById("graficoTemperatura").getContext("2d");
      const ctxHum = document.getElementById("graficoUmidade").getContext("2d");

      function getChartOptions(isDark) {
        const textColor = isDark ? "#f8f9fa" : "#212529";
        const gridColor = isDark ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)";
        return {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: textColor }, grid: { color: gridColor } },
            y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
          },
        };
      }

      let chartTemp = new Chart(ctxTemp, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Temperatura (¬∞C)",
            data: tempData,
            borderColor: "#0d6efd",
            backgroundColor: "rgba(13, 110, 253, 0.2)",
            tension: 0.3,
            fill: true,
            pointRadius: 3,
          }],
        },
        options: getChartOptions(false),
      });

      let chartHum = new Chart(ctxHum, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Umidade (%)",
            data: humData,
            borderColor: "#0d6efd",
            backgroundColor: "rgba(13, 110, 253, 0.2)",
            tension: 0.3,
            fill: true,
            pointRadius: 3,
          }],
        },
        options: getChartOptions(false),
      });

      function updateChartTheme(isDark) {
        const options = getChartOptions(isDark);
        chartTemp.options = options;
        chartHum.options = options;
        chartTemp.update();
        chartHum.update();
      }

      client.on("connect", () => {
        console.log("üåê Conectado ao broker MQTT (WebSocket)");
        client.subscribe("senai/iot/dht11");
      });

      client.on("message", (topic, message) => {
        const data = JSON.parse(message.toString());
        const time = new Date().toLocaleTimeString();

        labels.push(time);
        tempData.push(data.temperatura);
        humData.push(data.umidade);

        // Limita a 20 pontos no gr√°fico
        if (labels.length > 20) {
          labels.shift();
          tempData.shift();
          humData.shift();
        }

        document.getElementById("valorTemp").innerText = data.temperatura.toFixed(1);
        document.getElementById("valorHum").innerText = data.umidade.toFixed(1);

        const LIMITE_TEMPERATURA = 30;
        const alerta = document.getElementById("alertaTemperatura");

        if (data.temperatura >= LIMITE_TEMPERATURA) {
          chartTemp.data.datasets[0].borderColor = "#dc3545";
          chartTemp.data.datasets[0].backgroundColor = "rgba(220, 53, 69, 0.2)";
          alerta.classList.remove("d-none");
        } else {
          chartTemp.data.datasets[0].borderColor = "#0d6efd";
          chartTemp.data.datasets[0].backgroundColor = "rgba(13, 110, 253, 0.2)";
          alerta.classList.add("d-none");
        }

        chartTemp.update();
        chartHum.update();
      });

      const toggleBtn = document.getElementById("toggleTema");
      let isDarkMode = false;

      toggleBtn.addEventListener("click", () => {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle("dark-mode", isDarkMode);
        toggleBtn.innerText = isDarkMode ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Escuro";
        updateChartTheme(isDarkMode);
      });
    });
  </script>
</body>
</html>
